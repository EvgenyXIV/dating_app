<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dating Platform API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        .auth-section {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            background: #2196F3;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            background: #1976D2;
        }
        .btn-success {
            background: #4CAF50;
        }
        .btn-success:hover {
            background: #45a049;
        }
        .endpoint {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .method {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        .get { background: #d4edda; color: #155724; }
        .post { background: #d1ecf1; color: #0c5460; }
        .put { background: #fff3cd; color: #856404; }
        .patch { background: #ffeaa7; color: #856404; }
        .delete { background: #f8d7da; color: #721c24; }
        .auth-badge {
            background: #ff4444;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 10px;
        }
        .url {
            font-family: monospace;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            word-break: break-all;
        }
        .user-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .authenticated {
            background: #d4edda;
            color: #155724;
        }
        .anonymous {
            background: #f8d7da;
            color: #721c24;
        }
        .test-creds {
            background: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Dating Platform API</h1>
        <p>API –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∑–Ω–∞–∫–æ–º—Å—Ç–≤ | –í–µ—Ä—Å–∏—è 1.0.0</p>
    </div>

    <div id="authStatus">
        <div class="user-status anonymous">
            üîê –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        </div>
    </div>

    <div class="auth-section">
        <h2>üîë –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
        <p>–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è JWT (—Ç–æ–∫–µ–Ω –≤—ã–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ /api-auth/login/</p>
        <p>–∏–ª–∏ –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ /api/token/ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π).</p>
        <div></div>
        <p><strong>–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —É—á—ë—Ç–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (dev-—Ä–µ–∂–∏–º)</strong></p>
        
        <div>
            <button class="btn" onclick="quickLogin('test_user')">
                –í–æ–π—Ç–∏ –∫–∞–∫ Test User
            </button>
            <button class="btn" onclick="quickLogin('admin')">
                –í–æ–π—Ç–∏ –∫–∞–∫ Admin
            </button>
            <a href="/swagger/" class="btn btn-success">
                Swagger Docs
            </a>
        </div>

        <div class="test-creds">
            <h3>–¢–µ—Å—Ç–æ–≤—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</h3>
            <p><strong>Test User:</strong> test@test.ru / password</p>
            <p><strong>Admin:</strong> admin@admin.ru / password</p>
        </div>
    </div>

    <h2>üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã</h2>
    <div id="endpoints">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤...</p>
    </div>

    <script>
        //–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–Ω–¥–ø–æ–π–Ω—Ç—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        loadEndpoints();
        
        // –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç CSRF —Ç–æ–∫–µ–Ω –∏–∑ –∫—É–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç csrf-–∞—Ç–∞–∫
        // –í –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤–∫–ª—é—á–∞–µ–º —ç—Ç–æ—Ç CSRF-—Ç–æ–∫–µ–Ω –∏–Ω–∞—á–µ –∑–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏(JWT –∏–ª–∏ —Å–µ—Å—Å–∏—è)
        async function checkAuthStatus() {
            const token = localStorage.getItem('access_token');
            const authStatus = document.getElementById('authStatus');

            let isAuth = false;
            let email = 'unknown';

            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ JWT
            if (token) {
                try {
                    const response = await fetch('/api/users/profile/', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        email = data.email || 'unknown';
                        isAuth = true;
                    }
                } catch (err) {
                    console.warn('JWT –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å:', err);
                }
            }

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Å–µ—Å—Å–∏–∏ (–µ—Å–ª–∏ JWT –Ω–µ—Ç –∏–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
            if (!isAuth) {
                try {
                    const response = await fetch('/api/users/profile/', {
                        method: 'GET',
                        credentials: 'include'  // üî• –ø–µ—Ä–µ–¥–∞—ë—Ç sessionid
                    });

                    if (response.ok) {
                        const data = await response.json();
                        email = data.email || 'unknown';
                        isAuth = true;
                    }
                } catch (err) {
                    console.warn('–°–µ—Å—Å–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫—É:', err);
                }
            }

            // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è UI
            if (isAuth) {
                authStatus.innerHTML = `
                    <div class="user-status authenticated">
                        ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${email}
                        <button class="btn" onclick="logout()" style="margin-left: 10px; padding: 5px 10px; background: #666;">
                            –í—ã–π—Ç–∏
                        </button>
                    </div>
                `;
            } else {
                authStatus.innerHTML = '<div class="user-status anonymous">üîê –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>';
            }
        }

        // –ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ JWT –∏ —Å–µ—Å—Å–∏–∏
        async function quickLogin(accountType) {
            let email, password;

            if (accountType === 'test_user') {
                email = 'test@test.ru';
                password = 'password';
            } else if (accountType === 'admin') {
                email = 'admin@admin.ru';
                password = 'password'; 
            } else {
             alert('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞');
                return;
            }

            const messages = [];

            // 1. –í—Ö–æ–¥ –ø–æ JWT
            try {
                const jwtRes = await fetch('/api/token/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });

                if (jwtRes.ok) {
                    const data = await jwtRes.json();
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    messages.push('‚úÖ JWT ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                } else {
                    const error = await jwtRes.json().catch(() => ({}));
                    messages.push(`‚ùå JWT: ${error.detail || '–æ—à–∏–±–∫–∞'}`);
                }
            } catch (err) {
                messages.push(`üåê JWT: ${err.message}`);
            }

            // 2. –í—Ö–æ–¥ –ø–æ —Å–µ—Å—Å–∏–∏
            try {
                const sessionRes = await fetch('/api-auth/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'include',
                    body: new URLSearchParams({ username: email, password, next: '/api/' })
                });

                if (sessionRes.ok || sessionRes.redirected || sessionRes.status === 302) {
                    messages.push('‚úÖ –°–µ—Å—Å–∏—è ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                } else {
                    const text = await sessionRes.text();
                    messages.push(`‚ùå –°–µ—Å—Å–∏—è: ${text.includes('csrf') ? 'CSRF' : '–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å'}`);
                }
                } catch (err) {
                messages.push(`üåê –°–µ—Å—Å–∏—è: ${err.message}`);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            alert(`–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—Ö–æ–¥–∞:\n\n${messages.join('\n')}`);

            // –û–±–Ω–æ–≤–ª—è–µ–º UI ‚Äî checkAuthStatus —Å–∞–º —Ä–µ—à–∏—Ç, —á—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å
            checkAuthStatus();
            loadEndpoints();
        }

        function logout() {
            // 1. –£–¥–∞–ª—è–µ–º JWT
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');

            // 2. –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–π—Ç–∏ –∏–∑ —Å–µ—Å—Å–∏–∏
            fetch('/api-auth/logout/', {
                method: 'POST',
                headers: {
                'X-CSRFToken': getCSRFToken()
                },
                credentials: 'include'  // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∫—É–∫
            }).catch(() => {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—ë —Ä–∞–≤–Ω–æ –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ UI
            }).finally(() => {
                // 3. –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî –≤—Å–µ–≥–¥–∞
                const authStatus = document.getElementById('authStatus');
                authStatus.innerHTML = '<div class="user-status anonymous">üîê –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>';
                loadEndpoints();
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
        async function loadEndpoints() {
            try {
                const token = localStorage.getItem('access_token');
                const headers = {};

                // –ï—Å–ª–∏ –µ—Å—Ç—å JWT - —É–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –≤ –∑–∞–ø—Ä–æ—Å–µ
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –∏ CSRF-—Ç–æ–∫–µ–Ω, –µ—Å–ª–∏ –µ—Å—Ç—å
                const csrfToken = getCSRFToken();
                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }

                // –í—Å–µ–≥–¥–∞ –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ api_root
                const response = await fetch('/api/root/', {
                    headers: headers,
                    credentials: 'include'
                });

                console.log('‚úÖ Response status:', response.status);

                if (!response.ok) {
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É');
                }

                const data = await response.json();

                console.log('üîß data:', JSON.stringify(data, null, 2));
                console.log('‚úÖ JSON –ø–æ–ª—É—á–µ–Ω:', data);
                console.dir(data);

                if (!data || !data.endpoints) {
                    console.error('‚ùå –ù–µ—Ç –ø–æ–ª—è endpoints:', data);
                    throw new Error('Invalid API structure');
                }

                displayEndpoints(data.endpoints);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:', error);

                // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π fallback
                const container = document.getElementById('endpoints');
                container.innerHTML = `
                    <div class="endpoint">
                        <div><strong>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤</strong></div>
                        <div class="url">/api/root/ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>
                        <div>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.</div>
                    </div>
                `;
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
        function displayEndpoints(endpoints) {
            const container = document.getElementById('endpoints');
            let html = '';

            for (const [category, categoryEndpoints] of Object.entries(endpoints)) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ categoryEndpoints
                if (!categoryEndpoints || typeof categoryEndpoints !== 'object') {
                    console.warn('Invalid category endpoints:', category, categoryEndpoints);
                    continue;
                }

                html += `<h3>${category.toUpperCase()}</h3>`;
                
                for (const [endpointName, endpoint] of Object.entries(categoryEndpoints)) {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ endpoint
                    if (!endpoint || typeof endpoint !== 'object' || !categoryEndpoints.hasOwnProperty(endpointName)) {
                        console.warn('–ü—Ä–æ–ø—É—â–µ–Ω endpoint(–Ω–µ –æ–±—ä–µ–∫—Ç –∏–ª–∏ –Ω–µ hasOwnProperty):', endpointName, endpoint);
                        continue;
                    }

                    // –ó–∞—â–∏—Ç–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º method
                    if (!endpoint.method || typeof endpoint.method !== 'string') {
                        console.error('–£ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –Ω–µ—Ç method:', endpointName, endpoint);
                        endpoint.method = 'GET'; // fallback
                    }

                    const methods = endpoint.method.split(',').map(m => m.trim().toLowerCase());
                    
                    html += `
                        <div class="endpoint">
                            <div>
                                <strong>${endpointName.replace(/_/g, ' ')}</strong>
                                ${endpoint.authentication_required ? '<span class="auth-badge">AUTH</span>' : ''}
                            </div>
                            <div class="url">
                                <a href="${endpoint.url}" target="_blank" style="color: #2196F3; text-decoration: none;"}>
                                    ${endpoint.url}
                                </a>
                            </div>
                            <div>
                                ${methods.map(m => `<span class="method ${m}">${m.toUpperCase()}</span>`).join('')}
                            </div>
                            <div>${endpoint.description}</div>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            loadEndpoints();
        });
    </script>
</body>
</html>